rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ==================== USER PROFILE IMAGES ====================
    
    // User profile images - allow read/write for authenticated users
    match /users/{userId}/profile/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner');
    }
    
    // ==================== DOCUMENT UPLOADS ====================
    
    // User documents - allow read/write for authenticated users
    match /users/{userId}/documents/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner');
    }
    
    // ==================== TRANSACTION RECEIPTS ====================
    
    // Transaction receipts - allow read/write for authenticated users
    match /transactions/{transactionId}/receipts/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ==================== REPORTS ====================
    
    // Generated reports - allow read for authenticated users, write for owners
    match /reports/{reportId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== BACKUPS ====================
    
    // Backup files - only owners can access
    match /backups/{backupId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== EXPORTS ====================
    
    // Export files - only owners can access
    match /exports/{exportId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== TEMPLATES ====================
    
    // Message templates - allow read for all, write for owners
    match /templates/{templateId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== INTEGRATIONS ====================
    
    // Integration files - only owners can access
    match /integrations/{integrationId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== SYSTEM FILES ====================
    
    // System configuration files - only owners can access
    match /system/{configId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== LOGS ====================
    
    // Application logs - allow write for all, read for owners
    match /logs/{logId}/{fileName} {
      allow write: if request.auth != null;
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== CACHE ====================
    
    // Cache files - allow read/write for authenticated users
    match /cache/{cacheId}/{fileName} {
      allow read, write: if request.auth != null;
    }
    
    // ==================== TEMPORARY FILES ====================
    
    // Temporary files - allow read/write for authenticated users
    match /temp/{tempId}/{fileName} {
      allow read, write: if request.auth != null;
    }
    
    // ==================== VALIDATION RULES ====================
    
    // Validate file size (max 10MB)
    function isValidFileSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // Validate image file type
    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Validate document file type
    function isValidDocument() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }
    
    // Validate audio file type
    function isValidAudio() {
      return request.resource.contentType.matches('audio/.*');
    }
    
    // Validate video file type
    function isValidVideo() {
      return request.resource.contentType.matches('video/.*');
    }
    
    // ==================== ENHANCED RULES WITH VALIDATION ====================
    
    // Enhanced profile image rules
    match /users/{userId}/profile/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner') &&
        isValidFileSize() && isValidImage();
    }
    
    // Enhanced document rules
    match /users/{userId}/documents/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner') &&
        isValidFileSize() && isValidDocument();
    }
    
    // Enhanced transaction receipt rules
    match /transactions/{transactionId}/receipts/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        isValidFileSize() && (isValidImage() || isValidDocument());
    }
    
    // ==================== RATE LIMITING ====================
    
    // Rate limiting for file uploads
    match /rateLimits/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ==================== VERSIONING ====================
    
    // File versioning - allow read/write for authenticated users
    match /versions/{fileId}/{version}/{fileName} {
      allow read, write: if request.auth != null;
    }
    
    // ==================== SHARING ====================
    
    // Shared files - allow read for authenticated users
    match /shared/{shareId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== ARCHIVES ====================
    
    // Archived files - only owners can access
    match /archives/{archiveId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== COMPLIANCE ====================
    
    // Compliance files - only owners can access
    match /compliance/{complianceId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== SECURITY ====================
    
    // Security logs - only owners can access
    match /security/{securityId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== MONITORING ====================
    
    // Monitoring files - allow write for all, read for owners
    match /monitoring/{monitorId}/{fileName} {
      allow write: if request.auth != null;
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== ANALYTICS ====================
    
    // Analytics files - allow write for all, read for owners
    match /analytics/{analyticsId}/{fileName} {
      allow write: if request.auth != null;
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== INTEGRATIONS ====================
    
    // Integration files - only owners can access
    match /integrations/{integrationId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== CUSTOM FIELDS ====================
    
    // Custom field files - allow read/write for authenticated users
    match /customFields/{fieldId}/{fileName} {
      allow read, write: if request.auth != null;
    }
    
    // ==================== WORKFLOWS ====================
    
    // Workflow files - allow read for all, write for owners
    match /workflows/{workflowId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== TEMPLATES ====================
    
    // Template files - allow read for all, write for owners
    match /templates/{templateId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== FEATURE FLAGS ====================
    
    // Feature flag files - only owners can access
    match /featureFlags/{flagId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== SYSTEM CONFIG ====================
    
    // System configuration files - only owners can access
    match /systemConfig/{configId}/{fileName} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Function to check if user is owner
    function isOwner() {
      return request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'owner';
    }
    
    // Function to check if user is staff
    function isStaff() {
      return request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.role == 'staff';
    }
    
    // Function to check if user is active
    function isActiveUser() {
      return request.auth != null && 
        get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data.isActive == true;
    }
    
    // Function to check if user can access resource
    function canAccessResource(resourceUserId) {
      return request.auth != null && 
        (request.auth.uid == resourceUserId || isOwner());
    }
  }
}

